name: Test GitHub Connectivity to org

on:
  workflow_dispatch:
    inputs:
      runner_label:
        description: 'Runner label to use'
        required: false
        default: 'ubuntu-latest'
      test_iterations:
        description: 'Number of test iterations per job (36 jobs total in matrix)'
        required: false
        default: '5'
        type: string
      delay_between_tests:
        description: 'Delay between tests in seconds'
        required: false
        default: '5'
        type: string

jobs:
  test-connectivity:
    runs-on: ${{ inputs.runner_label }}
    strategy:
      fail-fast: false
      matrix:
        # Create 36 parallel jobs (6x6) to test across different runner machines
        set1: [1, 2, 3, 4, 5, 6]
        set2: [1, 2, 3, 4, 5, 6]
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Identify runner
        run: |
          echo "=== Runner Information (Job ${{ matrix.set1 }}.${{ matrix.set2 }}) ==="
          echo "Runner name: ${{ runner.name }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "Hostname: $(hostname)"
          echo "Matrix: set1=${{ matrix.set1 }}, set2=${{ matrix.set2 }}"
          echo ""

      - name: Test GitHub API connectivity
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Testing GitHub API connectivity ==="
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Runner: $(hostname)"
          echo ""

          # Test API access
          echo "Testing API access to organization..."
          if curl -s -f -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/orgs/forest-town > /dev/null; then
            echo "✓ API access successful"
          else
            echo "✗ API access failed"
            exit 1
          fi

      - name: Load test - Clone repositories with dynamic token issuance
        env:
          ITERATIONS: ${{ github.event.inputs.test_iterations || '10' }}
          DELAY: ${{ github.event.inputs.delay_between_tests || '5' }}
          ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${{ env.ACTIONS_ID_TOKEN_REQUEST_TOKEN }}
          ACTIONS_ID_TOKEN_REQUEST_URL: ${{ env.ACTIONS_ID_TOKEN_REQUEST_URL }}
          GH_TOK_VENDOR_HOSTNAME: github-token-vendor-prod-xxxxxxxxx.australia-southeast1.run.app
        run: |
          echo "=== Load Testing GitHub Clone Operations with Dynamic Token Issuance ==="
          echo "Iterations: $ITERATIONS"
          echo "Delay between tests: ${DELAY}s"
          echo ""

          SUCCESS_COUNT=0
          FAIL_COUNT=0
          TOTAL_TIME=0
          TOKEN_ISSUE_FAILURES=0
          RETRY_SUCCESS_COUNT=0

          # Function to issue a GHA OIDC token
          issue_gha_oidc_token() {
            AUDIENCE="https://${GH_TOK_VENDOR_HOSTNAME}"
            RESPONSE_BODY=$(curl -fsS \
              --get \
              -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" \
              -H "Accept: application/json" \
              "${ACTIONS_ID_TOKEN_REQUEST_URL}" \
              --data-urlencode "audience=${AUDIENCE}" 2>&1)

            if [ $? -ne 0 ]; then
              echo "ERROR: Failed to fetch OIDC token: ${RESPONSE_BODY}" >&2
              return 1
            fi

            TOKEN=$(echo "${RESPONSE_BODY}" | jq -r '.value')
            if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
              echo "ERROR: Invalid OIDC token response: ${RESPONSE_BODY}" >&2
              return 1
            fi
            echo "$TOKEN"
          }

          # Function to issue a GitHub token for a repository
          issue_github_token() {
            local REPO=$1
            local GHA_OIDC_TOKEN=$2

            REQUEST_BODY=$(jq -n -c --arg r "github.com/${REPO}" '{repository:$r}')
            RESPONSE_BODY=$(curl -fsS --http2 \
              --noproxy '*' \
              -H "Authorization: Bearer ${GHA_OIDC_TOKEN}" \
              "https://${GH_TOK_VENDOR_HOSTNAME}/token/issue" \
              -d "${REQUEST_BODY}" 2>&1)

            if [ $? -ne 0 ]; then
              echo "ERROR: Failed to issue GitHub token: ${RESPONSE_BODY}" >&2
              return 1
            fi

            TOKEN=$(echo "${RESPONSE_BODY}" | jq -r '.token')
            if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
              echo "ERROR: Invalid GitHub token response: ${RESPONSE_BODY}" >&2
              return 1
            fi
            echo "$TOKEN"
          }

          # Array of repositories to test
          REPOS=(
            "forest-town/repo-a"
            "forest-town/repo-b"
            "forest-town/repo-c"
            "forest-town/repo-d"
          )

          for i in $(seq 1 $ITERATIONS); do
            echo "--- Iteration $i/$ITERATIONS ---"
            ITERATION_START=$(date +%s)

            # Issue GHA OIDC token once per iteration
            echo "Issuing GHA OIDC token..."
            GHA_OIDC_TOKEN=$(issue_gha_oidc_token 2>&1)
            OIDC_EXIT_CODE=$?
            if [ $OIDC_EXIT_CODE -ne 0 ] || [ -z "$GHA_OIDC_TOKEN" ] || [ "$GHA_OIDC_TOKEN" = "null" ]; then
              echo "✗ Failed to issue GHA OIDC token (exit code: $OIDC_EXIT_CODE)"
              TOKEN_ISSUE_FAILURES=$((TOKEN_ISSUE_FAILURES + 1))
              continue
            fi
            echo "::add-mask::${GHA_OIDC_TOKEN}"
            echo "✓ GHA OIDC token issued (length: ${#GHA_OIDC_TOKEN})"
            echo ""

            for REPO in "${REPOS[@]}"; do
              REPO_NAME=$(basename $REPO)
              TEST_DIR="/tmp/test-clone-${REPO_NAME}-${i}"

              echo "Testing: $REPO"

              # Issue a fresh token for this specific repository
              echo "  Issuing GitHub token for ${REPO}..."
              TOKEN_START=$(date +%s)
              GH_TOKEN=$(issue_github_token "${REPO}" "${GHA_OIDC_TOKEN}" 2>&1)
              GH_TOKEN_EXIT_CODE=$?
              TOKEN_END=$(date +%s)
              TOKEN_DURATION=$((TOKEN_END - TOKEN_START))

              if [ $GH_TOKEN_EXIT_CODE -ne 0 ] || [ -z "$GH_TOKEN" ] || [ "$GH_TOKEN" = "null" ]; then
                echo "  ✗ Failed to issue GitHub token (duration: ${TOKEN_DURATION}s, exit code: $GH_TOKEN_EXIT_CODE)"
                TOKEN_ISSUE_FAILURES=$((TOKEN_ISSUE_FAILURES + 1))
                FAIL_COUNT=$((FAIL_COUNT + 1))
                continue
              fi
              echo "::add-mask::${GH_TOKEN}"
              echo "  ✓ Token issued (length: ${#GH_TOKEN}, duration: ${TOKEN_DURATION}s)"

              # Attempt to clone with the freshly issued token
              START_TIME=$(date +%s)
              CLONE_TMP="/tmp/clone_output_${REPO_NAME}_${i}.txt"
              set +e
              git clone "https://oauth2:${GH_TOKEN}@github.com/${REPO}.git" "$TEST_DIR" > "$CLONE_TMP" 2>&1
              CLONE_EXIT_CODE=$?
              set -e
              cat "$CLONE_TMP"  # Display the output
              CLONE_OUTPUT=$(cat "$CLONE_TMP")
              rm -f "$CLONE_TMP"

              if [ $CLONE_EXIT_CODE -eq 0 ]; then
                END_TIME=$(date +%s)
                DURATION=$((END_TIME - START_TIME))
                echo "✓ Success - Clone took ${DURATION}s"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                TOTAL_TIME=$((TOTAL_TIME + DURATION))

                # Cleanup
                rm -rf "$TEST_DIR"
              else
                END_TIME=$(date +%s)
                DURATION=$((END_TIME - START_TIME))
                echo "✗ Failed (attempt 1) - Exit code: $CLONE_EXIT_CODE, Duration: ${DURATION}s"
                echo "Error output: $CLONE_OUTPUT"

                # Token debugging on failure
                echo ""
                echo "=== Token Debug Information ==="
                echo "Token length: ${#GH_TOKEN}"
                echo "Token first 8 chars: ${GH_TOKEN:0:8}"
                echo "Token last 8 chars: ${GH_TOKEN: -8}"
                echo "Token pattern check: $(echo "$GH_TOKEN" | grep -oE '^[a-zA-Z0-9_-]+$' && echo 'Valid format' || echo 'Invalid characters detected')"
                echo ""

                # Retry once with the same token
                echo "Retrying with the same token (waiting 2s)..."
                sleep 2
                rm -rf "$TEST_DIR"

                RETRY_START=$(date +%s)
                RETRY_TMP="/tmp/retry_output_${REPO_NAME}_${i}.txt"
                set +e
                git clone "https://oauth2:${GH_TOKEN}@github.com/${REPO}.git" "$TEST_DIR" > "$RETRY_TMP" 2>&1
                RETRY_EXIT_CODE=$?
                set -e
                cat "$RETRY_TMP"  # Display the output
                RETRY_OUTPUT=$(cat "$RETRY_TMP")
                rm -f "$RETRY_TMP"
                RETRY_END=$(date +%s)
                RETRY_DURATION=$((RETRY_END - RETRY_START))

                if [ $RETRY_EXIT_CODE -eq 0 ]; then
                  echo "✓ Retry succeeded! - Duration: ${RETRY_DURATION}s"
                  echo "  => This indicates a transient network/proxy issue, NOT a token problem"
                  RETRY_SUCCESS_COUNT=$((RETRY_SUCCESS_COUNT + 1))
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  TOTAL_TIME=$((TOTAL_TIME + RETRY_DURATION))
                  rm -rf "$TEST_DIR"
                else
                  echo "✗ Retry failed - Exit code: $RETRY_EXIT_CODE, Duration: ${RETRY_DURATION}s"
                  echo "Error output: $RETRY_OUTPUT"
                  echo "  => Consistent failure with same token suggests token or persistent network issue"
                  FAIL_COUNT=$((FAIL_COUNT + 1))

                  # Additional diagnostics on persistent failure
                  echo ""
                  echo "=== Network Diagnostics (after retry failure) ==="
                  echo "- DNS resolution:"
                  nslookup github.com 2>&1 || true
                  echo ""

                  echo "- Proxy settings:"
                  env | grep -i proxy || echo "No proxy variables set"
                  echo ""

                  echo "- Test HTTPS connectivity:"
                  curl -v https://github.com 2>&1 | head -20 || true
                  echo ""
                fi
              fi
              echo ""
            done

            ITERATION_END=$(date +%s)
            ITERATION_DURATION=$((ITERATION_END - ITERATION_START))
            echo "Iteration $i completed in ${ITERATION_DURATION}s"

            # Delay between iterations (except for the last one)
            if [ $i -lt $ITERATIONS ]; then
              echo "Waiting ${DELAY}s before next iteration..."
              sleep $DELAY
            fi
            echo ""
          done

          # Summary
          TOTAL_TESTS=$((SUCCESS_COUNT + FAIL_COUNT))
          echo "=== Test Summary ==="
          echo "Total tests: $TOTAL_TESTS"
          echo "Successful: $SUCCESS_COUNT"
          echo "  - First attempt success: $((SUCCESS_COUNT - RETRY_SUCCESS_COUNT))"
          echo "  - Retry success (transient failures): $RETRY_SUCCESS_COUNT"
          echo "Failed: $FAIL_COUNT"
          echo "Token issuance failures: $TOKEN_ISSUE_FAILURES"

          if [ $SUCCESS_COUNT -gt 0 ]; then
            AVG_TIME=$((TOTAL_TIME / SUCCESS_COUNT))
            echo "Average clone time: ${AVG_TIME}s"
          fi

          if [ $FAIL_COUNT -gt 0 ] || [ $TOKEN_ISSUE_FAILURES -gt 0 ] || [ $RETRY_SUCCESS_COUNT -gt 0 ]; then
            if [ $TOTAL_TESTS -gt 0 ]; then
              FAIL_RATE=$(awk "BEGIN {printf \"%.2f\", ($FAIL_COUNT / $TOTAL_TESTS) * 100}")
              echo "Clone failure rate: ${FAIL_RATE}%"
            fi
            echo ""
            if [ $RETRY_SUCCESS_COUNT -gt 0 ]; then
              TRANSIENT_RATE=$(awk "BEGIN {printf \"%.2f\", ($RETRY_SUCCESS_COUNT / $TOTAL_TESTS) * 100}")
              echo "⚠️  Transient failures detected: $RETRY_SUCCESS_COUNT ($TRANSIENT_RATE%)"
              echo "  These succeeded on retry, indicating intermittent network/proxy issues"
            fi
            if [ $TOKEN_ISSUE_FAILURES -gt 0 ]; then
              echo "⚠️  Token issuance failures detected! This indicates issues with:"
              echo "  - GitHub Token Vendor connectivity"
              echo "  - OIDC token generation"
              echo "  - Network connectivity to ${GH_TOK_VENDOR_HOSTNAME}"
            fi
            if [ $FAIL_COUNT -gt 0 ]; then
              echo "⚠️  Repository clone failures detected! (Failed even after retry)"
            fi
            exit 1
          else
            echo "Success rate: 100%"
            echo "✓ All connectivity and token issuance tests passed on first attempt"
          fi

